redis-cluster-tutorial
======================

[Redis cluster tutorial](https://redis.io/topics/cluster-tutorial)

# Preparation

```
make prepare
```

# Startup nodes

```
make up
```

# Create cluster

```
make cluster/create
```

output log.
```
bundle exec ./bin/redis-trib.rb create --replicas 1 127.0.0.1:7100 127.0.0.1:7101 127.0.0.1:7102 127.0.0.1:7103 127.0.0.1:7104 127.0.0.1:7105
>>> Creating cluster
>>> Performing hash slots allocation on 6 nodes...
Using 3 masters:
127.0.0.1:7100
127.0.0.1:7101
127.0.0.1:7102
Adding replica 127.0.0.1:7103 to 127.0.0.1:7100
Adding replica 127.0.0.1:7104 to 127.0.0.1:7101
Adding replica 127.0.0.1:7105 to 127.0.0.1:7102
M: 9028c4dff477aba846f925ec7333c5b08491cc1f 127.0.0.1:7100
   slots:0-5460 (5461 slots) master
M: 578fd645172745551d2cc9a47c00c0acbc3781ea 127.0.0.1:7101
   slots:5461-10922 (5462 slots) master
M: 1cc9201c2a7a545a12b42653a73282c348f874cb 127.0.0.1:7102
   slots:10923-16383 (5461 slots) master
S: 27104c1a6dbf13f4298b7e89869847ae6dd4d1ba 127.0.0.1:7103
   replicates 9028c4dff477aba846f925ec7333c5b08491cc1f
S: 94d4da4d2d7729ff16b9990386579a728c70f54e 127.0.0.1:7104
   replicates 578fd645172745551d2cc9a47c00c0acbc3781ea
S: 8c0b4a605f049615a7bd645909a4287c8b36ba4e 127.0.0.1:7105
   replicates 1cc9201c2a7a545a12b42653a73282c348f874cb
Can I set the above configuration? (type 'yes' to accept): yes
>>> Nodes configuration updated
>>> Assign a different config epoch to each node
>>> Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join...
>>> Performing Cluster Check (using node 127.0.0.1:7100)
M: 9028c4dff477aba846f925ec7333c5b08491cc1f 127.0.0.1:7100
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
S: 8c0b4a605f049615a7bd645909a4287c8b36ba4e 127.0.0.1:7105
   slots: (0 slots) slave
   replicates 1cc9201c2a7a545a12b42653a73282c348f874cb
S: 94d4da4d2d7729ff16b9990386579a728c70f54e 127.0.0.1:7104
   slots: (0 slots) slave
   replicates 578fd645172745551d2cc9a47c00c0acbc3781ea
S: 27104c1a6dbf13f4298b7e89869847ae6dd4d1ba 127.0.0.1:7103
   slots: (0 slots) slave
   replicates 9028c4dff477aba846f925ec7333c5b08491cc1f
M: 1cc9201c2a7a545a12b42653a73282c348f874cb 127.0.0.1:7102
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
M: 578fd645172745551d2cc9a47c00c0acbc3781ea 127.0.0.1:7101
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```

# Insert example data

```
make example
```

# Add new nodes (auto-rebalanced)

```
make up/reinforcement
```

```
# In another console
make cluster/reinforce
```

output log.
```
bundle exec ./bin/redis-trib.rb add-node 127.0.0.1:7106 127.0.0.1:7100
>>> Adding node 127.0.0.1:7106 to cluster 127.0.0.1:7100
>>> Performing Cluster Check (using node 127.0.0.1:7100)
M: 9028c4dff477aba846f925ec7333c5b08491cc1f 127.0.0.1:7100
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
S: 8c0b4a605f049615a7bd645909a4287c8b36ba4e 127.0.0.1:7105
   slots: (0 slots) slave
   replicates 1cc9201c2a7a545a12b42653a73282c348f874cb
S: 94d4da4d2d7729ff16b9990386579a728c70f54e 127.0.0.1:7104
   slots: (0 slots) slave
   replicates 578fd645172745551d2cc9a47c00c0acbc3781ea
S: 27104c1a6dbf13f4298b7e89869847ae6dd4d1ba 127.0.0.1:7103
   slots: (0 slots) slave
   replicates 9028c4dff477aba846f925ec7333c5b08491cc1f
M: 1cc9201c2a7a545a12b42653a73282c348f874cb 127.0.0.1:7102
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
M: 578fd645172745551d2cc9a47c00c0acbc3781ea 127.0.0.1:7101
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
>>> Send CLUSTER MEET to node 127.0.0.1:7106 to make it join the cluster.
[OK] New node added correctly.
bundle exec ./bin/redis-trib.rb add-node --slave 127.0.0.1:7107 127.0.0.1:7106
>>> Adding node 127.0.0.1:7107 to cluster 127.0.0.1:7106
>>> Performing Cluster Check (using node 127.0.0.1:7106)
M: c85ceb7f16012b26cfb1604b0513cafe83383841 127.0.0.1:7106
   slots: (0 slots) master
   0 additional replica(s)
M: 1cc9201c2a7a545a12b42653a73282c348f874cb 127.0.0.1:7102
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: 94d4da4d2d7729ff16b9990386579a728c70f54e 127.0.0.1:7104
   slots: (0 slots) slave
   replicates 578fd645172745551d2cc9a47c00c0acbc3781ea
M: 578fd645172745551d2cc9a47c00c0acbc3781ea 127.0.0.1:7101
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
S: 8c0b4a605f049615a7bd645909a4287c8b36ba4e 127.0.0.1:7105
   slots: (0 slots) slave
   replicates 1cc9201c2a7a545a12b42653a73282c348f874cb
S: 27104c1a6dbf13f4298b7e89869847ae6dd4d1ba 127.0.0.1:7103
   slots: (0 slots) slave
   replicates 9028c4dff477aba846f925ec7333c5b08491cc1f
M: 9028c4dff477aba846f925ec7333c5b08491cc1f 127.0.0.1:7100
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
Automatically selected master 127.0.0.1:7106
>>> Send CLUSTER MEET to node 127.0.0.1:7107 to make it join the cluster.
Waiting for the cluster to join.
>>> Configure node as replica of 127.0.0.1:7106.
[OK] New node added correctly.
bundle exec ./bin/redis-trib.rb rebalance --use-empty-masters --auto-weights 127.0.0.1:7100
>>> Performing Cluster Check (using node 127.0.0.1:7100)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
>>> Rebalancing across 4 nodes. Total weight = 4
Moving 1366 slots from 127.0.0.1:7101 to 127.0.0.1:7106
######################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
Moving 1365 slots from 127.0.0.1:7102 to 127.0.0.1:7106
#####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
Moving 1365 slots from 127.0.0.1:7100 to 127.0.0.1:7106
#####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
```
